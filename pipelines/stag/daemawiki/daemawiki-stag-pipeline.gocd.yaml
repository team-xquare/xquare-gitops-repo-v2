---
# Source: gocd/templates/pipeline.yaml
format_version: 11
pipelines:
  build-daemawiki-stag:
    group: xquare
    environment_variables:

    label_template: "${git[:7]}"
    materials:
      git:
        git: https://github.com/daemawiki/Claude
        shallow_clone: false
        auto_update: true
        branch: develop
    stages:
      - build:
          jobs:
            build:
              elastic_profile_id: daemawiki-stag-agent-profile
              artifacts:
                - build:
                    source: build_result.env
                    destination: artifacts
              tasks:
                - exec:
                    command: /bin/bash
                    arguments:
                      - -c
                      - |
                        curl -o template.json https://raw.githubusercontent.com/team-xquare/xquare-gitops-repo-v2/main/pipelines/stag/daemawiki/template.json
                        TEMPLATE_JSON=$(cat template.json)
                        BUILD_DIR=$(echo "$TEMPLATE_JSON" | jq -r '.build_dir // "/"')

                        if [[ "$BUILD_DIR" == /* ]]; then
                        BUILD_DIR="./${BUILD_DIR#/}"
                        fi

                        cd "$BUILD_DIR" || { echo "디렉토리 이동 실패: $BUILD_DIR"; exit 1; }

                        curl -o docker_build.sh https://raw.githubusercontent.com/team-xquare/xquare-gitops-repo-v2/main/script/docker_build.sh
                        curl -o Dockerfile https://raw.githubusercontent.com/team-xquare/xquare-gitops-repo-v2/main/pipelines/stag/daemawiki/Dockerfile
                        chmod +x docker_build.sh
                        ./docker_build.sh stag daemawiki
      - deploy:
          jobs:
            deploy:
              elastic_profile_id: deploy-agent-profile
              tasks:
                - fetch:
                    run_if: any
                    artifact_origin: gocd
                    stage: build
                    job: build
                    is_file: yes
                    source: artifacts/build_result.env
                    destination: environment
                - exec:
                    command: /bin/bash
                    arguments:
                      - -c
                      - |
                        cat environment/build_result.env
                        source environment/build_result.env

                        curl -o resource_deploy.sh https://raw.githubusercontent.com/team-xquare/xquare-gitops-repo-v2/main/script/resource_deploy.sh
                        chmod +x resource_deploy.sh
                        SANITIZED_NAME=$(echo daemawiki | sed 's/-/_/g')
                        RESOURCE_VAR_NAME="${SANITIZED_NAME}_REPOSITORY"
                        ./resource_deploy.sh daemawiki stag ${!RESOURCE_VAR_NAME}
